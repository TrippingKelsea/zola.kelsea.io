{% extends "base.html" %}

{% block title %}
{% if page.extra.chapter_number %}Chapter {{ page.extra.chapter_number }}: {% endif %}{{ page.title }} - {{ config.title }}
{% endblock %}

{% block extra_head %}
{% if page.extra.content_warning %}
{# Exclude chapters with content warnings from search engines #}
<meta name="robots" content="noindex, nofollow">
{% endif %}
{% endblock %}

{% block content %}
<div class="terminal-output">
    <div class="terminal-section chapter-header">
        <span class="prompt-line">$ cat chapter_{{ page.extra.chapter_number | default(value="00") }}.md</span>

        <div class="chapter-metadata">
            <div class="meta-row">
                {% if page.extra.chapter_number %}
                <span class="meta-item">
                    <span class="meta-label">Chapter:</span>
                    {{ page.extra.chapter_number }}
                </span>
                {% endif %}

                <span class="meta-item">
                    <span class="meta-label">Reading time:</span>
                    {{ page.reading_time }} min
                </span>

                <span class="meta-item">
                    <span class="meta-label">Words:</span>
                    {{ page.word_count }}
                </span>

                {% if page.date %}
                <span class="meta-item">
                    <span class="meta-label">Updated:</span>
                    {{ page.date | date(format="%Y-%m-%d") }}
                </span>
                {% endif %}
            </div>

            {% if page.extra.status %}
            <div class="meta-row">
                <span class="meta-item">
                    <span class="meta-label">Status:</span>
                    <span class="status-badge status-{{ page.extra.status | slugify }}">
                        {{ page.extra.status }}
                    </span>
                </span>
            </div>
            {% endif %}
        </div>
    </div>

    {# Chapter Navigation - Top #}
    {# Note: Using lower/higher because section sorts by weight #}
    {% if page.lower or page.higher %}
    <nav class="terminal-section chapter-navigation chapter-navigation-top" aria-label="Chapter navigation">
        <span class="prompt-line">$ navigate chapters</span>
        <div class="output-text nav-chapters">
            {% if page.lower %}
            <div class="nav-chapter prev-chapter">
                <span class="nav-label">← Previous Chapter</span>
                <a href="{{ page.lower.permalink }}">
                    {% if page.lower.extra.chapter_number %}
                    Chapter {{ page.lower.extra.chapter_number }}:
                    {% endif %}
                    {{ page.lower.title }}
                </a>
            </div>
            {% endif %}

            {% if page.higher %}
            <div class="nav-chapter next-chapter">
                <span class="nav-label">Next Chapter →</span>
                <a href="{{ page.higher.permalink }}">
                    {% if page.higher.extra.chapter_number %}
                    Chapter {{ page.higher.extra.chapter_number }}:
                    {% endif %}
                    {{ page.higher.title }}
                </a>
            </div>
            {% endif %}
        </div>
    </nav>
    {% endif %}

    <article class="chapter-content">
        <h1 class="chapter-title">
            {% if page.extra.chapter_number %}
            # Chapter {{ page.extra.chapter_number }}: {{ page.title }}
            {% else %}
            # {{ page.title }}
            {% endif %}
        </h1>

        {% if page.description %}
        <div class="chapter-intro">
            <em>{{ page.description }}</em>
        </div>
        {% endif %}

        {# Content Warning / Spoiler Section #}
        {% if page.extra.content_warning %}
        <div class="content-warning" role="region" aria-label="Content warning">
            <div class="content-warning-header">
                <span class="warning-icon" aria-hidden="true">⚠</span>
                <span class="warning-title">Content Warning</span>
            </div>
            <p class="warning-description">{{ page.extra.content_warning }}</p>
            <button
                type="button"
                class="reveal-content-btn"
                aria-expanded="false"
                aria-controls="chapter-body-{{ page.extra.chapter_number | default(value='content') }}"
            >
                <span class="reveal-text">Click or tap to reveal content</span>
                <span class="reveal-hint">(Press Enter or Space to reveal)</span>
            </button>
        </div>
        <div
            id="chapter-body-{{ page.extra.chapter_number | default(value='content') }}"
            class="chapter-body content-hidden"
            aria-hidden="true"
        >
            {{ page.content | safe }}
        </div>
        {% else %}
        <div class="chapter-body">
            {{ page.content | safe }}
        </div>
        {% endif %}
    </article>

    {# Chapter Navigation - Bottom #}
    {# Note: Using lower/higher because section sorts by weight #}
    {% if page.lower or page.higher %}
    <nav class="terminal-section chapter-navigation chapter-navigation-bottom" aria-label="Chapter navigation">
        <span class="prompt-line">$ navigate chapters</span>
        <div class="output-text nav-chapters">
            {% if page.lower %}
            <div class="nav-chapter prev-chapter">
                <span class="nav-label">← Previous Chapter</span>
                <a href="{{ page.lower.permalink }}">
                    {% if page.lower.extra.chapter_number %}
                    Chapter {{ page.lower.extra.chapter_number }}:
                    {% endif %}
                    {{ page.lower.title }}
                </a>
            </div>
            {% endif %}

            {% if page.higher %}
            <div class="nav-chapter next-chapter">
                <span class="nav-label">Next Chapter →</span>
                <a href="{{ page.higher.permalink }}">
                    {% if page.higher.extra.chapter_number %}
                    Chapter {{ page.higher.extra.chapter_number }}:
                    {% endif %}
                    {{ page.higher.title }}
                </a>
            </div>
            {% endif %}
        </div>
    </nav>
    {% endif %}

    <div class="terminal-section">
        <span class="prompt-line">$ cd ..</span>
        <div class="output-text">
            {% if page.ancestors %}
                {% set book_section = get_section(path=page.ancestors | last) %}
                <a href="{{ book_section.permalink }}">← Back to {{ book_section.extra.book_title | default(value=book_section.title) }}</a>
            {% else %}
                <a href="{{ get_url(path='/books') }}">← Back to books</a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
